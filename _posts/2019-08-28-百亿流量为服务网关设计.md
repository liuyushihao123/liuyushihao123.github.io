---
layout: post
title:  "百亿流量为服务网关设计"
categories: Java
tags:  程序员小灰
author: DuGuYu
---

* content
{:toc}

## API网关的职能
   一般来说，API网关有四大职能。   
    请求接入：作为所有API接口服务请求的接入点，管理所有的接入请求        
    业务聚合：作为所有后端业务服务的聚合点，所有的业务服务都可以在这里被调用 
    中介策略：实现安全、验证、路由、过 滤 流控、缓存等策略，进行一些必要的中介处理.    
    统一管理：提供配置管理工具，对所有API服务的调用生命周期和相应的中介策略进行统一管理。







    
    
    
    
    
    
    
    
    
    
## API网关的关注点
    在设计和实现API网关时，需要考虑两个目标：    
    现API网关时，需要考虑两个目标：
（1）开发维护简单，节约人力成本和维护成本。即应选择成熟的简单可维护的技术体系。    
（2）高性能，节约设备成本，提高系统吞吐能力。要求我们需要针对API网关的特点进行一些特定的设计和权衡.
   ## 
    海量并发的API网关最重要的三个关注点：
（1）保持大规模的inbound请求接入能力（长短连接），比如基于Netty实现。       
（2）最大限度地复用outbound的HTTP连接能力，比如基于HttpClient4的异步HttpClient实现。    
（3）方便灵活地实现安全、验证、过滤、聚合、限流、监控等各种策略。     
 ## API网关的分类与技术分析
 ### 1. API网关的分类
    一类是全局性的，跟具体的后端业务系统和服务完全无关的部分，比如安全策略、全局性流控策略、流量分发策略等。
    一类是针对具体的后端业务系统，或者是服务和业务有一定关联性的部分，并且一般被直接部署在业务服务的前面。
 ### 2. 流量网关与WAF
      全局性流控；
      日志统计；
      防止SQL注入；
      防止Web攻击；
      屏蔽工具扫描；
      黑白名单控制。
 ####    一般的WAF具有如下功能： 
      防止SQL注入、部分溢出、fuzzing测试、XSS/SSRF等Web攻击；
      防止Apache Bench之类压力测试工具的攻击；
      屏蔽常见的扫描黑客工具，比如扫描器；
      禁止图片附件类目录执行权限、防止webshell上传；
      支持IP白名单和黑名单功能，直接拒绝黑名单的IP访问；
      支持URL白名单，定义不需要过滤的URL；
      支持User-Agent的过滤、支持CC攻击防护、限制单个URL指定时间的访问次数；
      支持支持Cookie过滤，URL与URL参数过滤；
      支持日志记录，将所有拒绝的操作记录到日志中。
 ### 3. 业务网关
     我们定义针对具体的后端业务系统，或者是服务和业务有一定关联性的策略网关，即为业务网关。比如，针对某个系统、某个服务或某个用户分类的流控策略，针对某一类服务的缓存策略，针对某个具体系统的权限验证方式，针对某些用户条件判断的请求过滤，针对具体几个相关API的数据聚合封装，等等。
     业务网关一般部署在流量网关之后、业务系统之前，比流量网关更靠近业务系统。我们大部分情况下说的API网关，狭义上指的是业务网关。如果系统的规模不大，我们也会将两者合二为一，使用一个网关来处理所有的工作。
## 业务网关的设计与最佳实践
  1. API网关1.0
我们的API网关1.0版本是多年前开发的，是直接使用OpenResty定制的，全局的安全测试、流量的路由转发策略、针对不同级别的限流等都是直接用Lua脚本实现。

这样就导致在经历了业务飞速发展以后，系统里存在非常多的相同功能或不同功能的Lua脚本，每次上线或维护都需要找到受影响的其中几个或几十个Lua脚本，进行策略调整，非常不方便，策略控制的粒度也不够细。

2. API网关2.0
在区分了流量网关和业务网关以后，2017年开始实现了流量网关和业务网关的分离，流量网关继续使用OpenResty定制，只保留少量全局性、不经常改动的配置功能和对应的Lua脚本。

业务网关使用Vert.x实现的Java系统，部署在流量网关和后端业务服务系统之间，利用Vert.x的响应式编程能力和异步非阻塞I/O能力、分布式部署的扩展能力，初步解决了问题1和问题2，如图7-13所示。![avatar](https://mmbiz.qpic.cn/mmbiz_png/nhlGsolibOWFNKdBbUJlIWd7S0S6cjmQ8icBFC9FEIknicXviaA4u9ia17uianUiaMjAxmkYqGWqTuwBBoGAFh6nMOLWA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

图7-13

Vert.x是一个基于事件驱动和异步非阻塞I/O、运行于JVM上的框架，如图7-14所示。在Vert.x里，Verticle是最基础的开发和部署单元，不同的Vert.x可以通过Event Bus传递数据，进而方便地实现高并发性能的网络程序。关于Vert.x原理的分析可以参考阿里架构师宿何的blog：
![avatar](https://mmbiz.qpic.cn/mmbiz_png/nhlGsolibOWFNKdBbUJlIWd7S0S6cjmQ8jJA3Pj5utFob5YzuWFPhQME5hG1uYenq5IRF8Kic2RwicJBDN7glXIGw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)
图7-14

Vert.x同时很好地支持了WebSocket协议，所以可以方便地实现支持REST API和WebSocket、完全异步的网关系统，如图7-15所示。
![avatar](https://mmbiz.qpic.cn/mmbiz_png/nhlGsolibOWFNKdBbUJlIWd7S0S6cjmQ8kibACS7JeH9fzDTiaRTAQwl9ygozwY6crrcEZibpyiat5TduhGVJEicPfbw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)
图7-15

一个高性能的API网关系统，缓存是必不可少的部分。无论分发冷热数据，降低对业务系统的压力，还是作为中间数据源，为服务聚合提供高效可复用的业务数据，缓存都发挥了巨大作用。

3. API网关的日常监控
我们使用多种工具对API进行监控和管理，包括全链路访问跟踪、连接数统计分析、全世界重要国家和城市的波测访问统计。网关技术团队每时每刻都关注着数据的变化趋势。各个业务系统研发团队每天安排专人关注自己系统的API性能（吞吐量和延迟），推进性能问题解决和持续优化。这就初步解决了问题3。

4. 推荐外部客户使用WebSocket和API SDK
由于外部客户需要自己通过API网关调用API服务来集成业务服务能力到自己的系统。各个客户的技术能力和系统处理能力有较大差异，使用行为也不同。对于不断发展变动的交易业务数据，客户调用API频率太低会影响数据实时性，调用频率太高则可能会浪费双方的系统资源。同时利用WebSocket的消息推送特点，我们可以在网关系统控制客户接收消息的频率、单个用户的连接数量等，随时根据业务系统的情况动态进行策略调整。综合考虑，WebSocket是一个比REST API更加实时可靠、更加易于管理的方式。另外对于习惯使用REST API的客户，我们也通过将各种常见使用场景封装成多种不同语言的API SDK（包括Java/C++/C#/Python），进而统一用户的API调用方式和行为。在研发、产品、运营各方的配合下，逐步协助客户使用WebSocket协议和API SDK，基本解决了问题4。

5. API网关的性能优化
API网关系统作为API服务的统一接入点，为了给用户提供最优质的用户体验，必须长期做性能优化工作。不仅API网关自己做优化，同时可以根据监控情况，时刻发现各业务系统的API服务能力，以此为出发点，推动各个业务系统不断优化API性能。

举一个具体的例子，某个网关系统连接经常强烈抖动（如图7-16所示），严重影响系统的稳定性、浪费系统资源，经过排除发现：
（1）有爬虫IP不断爬取我们的交易数据，而且这些IP所在网段都没有在平台产生任何实际交易，最高单爬虫IP的每日新建连接近100万次，平均每秒十几次。
（2）有部分API客户的程序存在bug，而且处理速度有限，不断地重复“断开并重新连接”，再尝试重新对API数据进行处理，严重影响了客户的用户体验。

针对如上分析，我们采取了如下处理方式：
（1）对于每天认定的爬虫IP，加入黑名单，直接在流量网关限制其访问我们的API网关。
（2）对于存在bug的API客户，协助对方进行问题定位和bug修复，增强客户使用信心。
（3）对于处理速度和技术能力有限的客户，基于定制的WebSocket服务，使用滑动时间窗口算法，在业务数据变化非常大时，对分发的消息进行批量优化。
![avatar](https://mmbiz.qpic.cn/mmbiz_png/nhlGsolibOWFNKdBbUJlIWd7S0S6cjmQ8PNcNSIgraLpJ5x5eNJ7KshMVMKJmKUlJxQ0UaNmib2eUbZmHrnZo9NA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)
图7-16

（4）对于未登录和识别身份的API调用，流量网关实现全局的流控策略，增加缓存时间和限制调用次数，保障系统稳定。
（5）业务网关根据API服务的重要等级和客户的分类，进一步细化和实时控制网关策略，最大限度地保障核心业务和客户的使用。

从监控图表可以看到，优化之后的效果非常明显，系统稳定，连接数平稳。
 
